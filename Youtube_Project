import googleapiclient.discovery
from googleapiclient.discovery import build
import pymongo
import pandas as pd
import streamlit as st

api_service_name = "youtube"
api_version = "v3"
api_key = 'AIzaSyChxcS4G0thj6eLminxF7VKEDYWEeoqfMM'
youtube = build('youtube', 'v3', developerKey=api_key)
def get_channel_details(channel_id):
    request = youtube.channels().list(part = 'snippet,contentDetails,statistics,status',id = channel_id)
    response = request.execute()
    for item in response["items"]:
            data = {
                    'channel_id':str(item["id"]),
                    'channel_name':str(item["snippet"]["title"]),
                    'channel_launch_date':item["snippet"]["publishedAt"],
                    'channel_description':item["snippet"]["description"],
                    'channel_views':int(item["statistics"]["viewCount"]),
                    'channel_subscription':int(item["statistics"]["subscriberCount"]),
                    'channel_video_count':int(item["statistics"]["videoCount"]),
                    'channel_playlist_id':item["contentDetails"]["relatedPlaylists"]["uploads"]
                    }
    return(data)

def get_playlist_details(playlist):
  video_id = []
  next_page_token = None
  while True:
      request = youtube.playlistItems().list(part = 'contentDetails', playlistId = playlist,  maxResults = 50, pageToken = next_page_token)
      response = request.execute()
      for item in response["items"]:
          video_id.append(item["contentDetails"]["videoId"])
      next_page_token = response.get("nextPageToken")
      if not next_page_token:
        break
  return video_id

def get_video_details(video_ids):
  video_details =[]
  for video_id in video_ids:
    request = youtube.videos().list(part = 'snippet,contentDetails,statistics', id = video_id)
    response = request.execute()
    for item in response["items"]:
        data = {
              'video_id' : item["id"],
              'channel_id' : item["snippet"]["channelId"],
              'channel_name' : item["snippet"]["channelTitle"],
              'video_name' : item["snippet"]["title"],
              'video_date' : item["snippet"]["publishedAt"],
              'video_description' : item["snippet"]["description"],
              'video_duration' :duration(item["contentDetails"]["duration"]),
              'video_views' : int(item["statistics"]["viewCount"])if 'viewCount' in response['items'][0]['statistics'] else 0,
              'video_likes' : int(item["statistics"]["likeCount"]) if 'likeCount' in response['items'][0]['statistics'] else 0,
              'video_dislikes' :int( item["statistics"]["dislikeCount"]) if 'dislikeCount' in response['items'][0]['statistics'] else 0,
              'video_favourite' : int(item["statistics"]["favoriteCount"]) if 'favoriteCount' in response['items'][0]['statistics'] else 0,
              'video_comment_count' : int(item["statistics"]["commentCount"]) if 'commentCount' in response['items'][0]['statistics'] else 0,
              }
        video_details.append(data)
  return video_details

def get_comment_details(video_ids):
    comment_list = []
    for video_id in video_ids:
        try:
            request = youtube.commentThreads().list(part='snippet', videoId=video_id, maxResults=50)
            response = request.execute()
            if 'items' not in response:
                continue
            for item in response["items"]:
                 comment_details = {
                        'comment_id': item['snippet']['topLevelComment']['id'],
                        'video_id': video_id,
                        'comment_text': item['snippet']['topLevelComment']['snippet']['textDisplay'],
                        'comment_author': item['snippet']['topLevelComment']['snippet']['authorDisplayName'],
                        'commented_on': item['snippet']['topLevelComment']['snippet']['publishedAt']
                        }
                 comment_list.append(comment_details)
        except :
            continue
    return comment_list

from pymongo import MongoClient
client = pymongo.MongoClient("mongodb+srv://pnhurukadli:O9IWeOJZj89cJxwe@cluster0.tmqwxri.mongodb.net/?retryWrites=true&w=majority")
db = client['test']
db

db = client['youtube']
col_1 = db['channel_details']
def get_channel_details_1(channel_id):
    api_key = "AIzaSyChxcS4G0thj6eLminxF7VKEDYWEeoqfMM"
    api_service_name = "youtube"
    api_version = "v3"

    youtube = build(api_service_name, api_version, developerKey=api_key)
    request = youtube.channels().list(part = 'snippet,contentDetails,statistics,status',id = channel_id)
    response = request.execute()
    for item in response["items"]:
            data = {
                    'channel_id':str(item["id"]),
                    'channel_name':str(item["snippet"]["title"]),
                    'channel_launch_date':item["snippet"]["publishedAt"],
                    'channel_description':item["snippet"]["description"],
                    'channel_views':int(item["statistics"]["viewCount"]),
                    'channel_subscription':int(item["statistics"]["subscriberCount"]),
                    'channel_video_count':int(item["statistics"]["videoCount"]),
                    'channel_playlist_id':item["contentDetails"]["relatedPlaylists"]["uploads"]
                    }
    return(data)


db = client['youtube']
col_2 = db['video_details']
def get_video_details(video_ids):
  video_details =[]
  api_key = "AIzaSyChxcS4G0thj6eLminxF7VKEDYWEeoqfMM"
  api_service_name = "youtube"
  api_version = "v3"
  youtube = build(api_service_name, api_version, developerKey=api_key)
  for video_id in video_ids:
    request = youtube.videos().list(part = 'snippet,contentDetails,statistics', id = video_id)
    response = request.execute()
    for item in response["items"]:
        data = {
              'video_id' : item["id"],
              'channel_id' : item["snippet"]["channelId"],
              'channel_name' : item["snippet"]["channelTitle"],
              'video_name' : item["snippet"]["title"],
              'video_date' : item["snippet"]["publishedAt"],
              'video_description' : item["snippet"]["description"],
              'video_duration' :item["contentDetails"]["duration"],
              'video_views' : int(item["statistics"]["viewCount"])if 'viewCount' in response['items'][0]['statistics'] else 0,
              'video_likes' : int(item["statistics"]["likeCount"]) if 'likeCount' in response['items'][0]['statistics'] else 0,
              'video_dislikes' :int( item["statistics"]["dislikeCount"]) if 'dislikeCount' in response['items'][0]['statistics'] else 0,
              'video_favourite' : int(item["statistics"]["favoriteCount"]) if 'favoriteCount' in response['items'][0]['statistics'] else 0,
              'video_comment_count' : int(item["statistics"]["commentCount"]) if 'commentCount' in response['items'][0]['statistics'] else 0,
              }
        video_details.append(data)
  return(video_details)


db = client['youtube']
col_3 = db['comment_details']
def get_comment_details(video_ids):
    comment_list = []
    api_key = "AIzaSyChxcS4G0thj6eLminxF7VKEDYWEeoqfMM"
    api_service_name = "youtube"
    api_version = "v3"
    youtube = build(api_service_name, api_version, developerKey=api_key)
    for video_id in video_ids:
        try:
            request = youtube.commentThreads().list(part='snippet', videoId=video_id, maxResults=50)
            response = request.execute()
            if 'items' not in response:
                continue
            for item in response["items"]:
                 comment_details = {
                        'comment_id': item['snippet']['topLevelComment']['id'],
                        'video_id': video_id,
                        'comment_text': item['snippet']['topLevelComment']['snippet']['textDisplay'],
                        'comment_author': item['snippet']['topLevelComment']['snippet']['authorDisplayName'],
                        'commented_on': item['snippet']['topLevelComment']['snippet']['publishedAt']
                        }
                 comment_list.append(comment_details)
        except :
            continue
    return comment_list

def get_channel_details_1(channel_id):
    ch_details = get_channel_details(channel_id)
    playlist = ch_details["channel_playlist_id"]
    video_ids = get_playlist_details(playlist)
    vi_ids =  get_video_details(video_ids)
    com_details = get_comment_details(video_ids)
    coll1 = db["channel_details"]
    coll1.insert_one({"channel_information":ch_details,"video_information":vi_ids," comment_information":com_details})
    return "uploaded completed successfully"

ch_list = []
db = client["youtube"]
coll1 = db["channel_details"]
for ch_data in coll1.find({},{"_id":0}):
    ch_list.append(ch_data["channel_information"])
df = pd.DataFrame(ch_list)
df


import mysql.connector
mycon = mysql.connector.connect(
    host = "localhost",
    user = "root",
    password="12345",
    database = "youtube"
)
mycursor = mycon.cursor()

create_query = '''CREATE TABLE IF NOT EXISTS youtube.channel_information (
                   channel_name VARCHAR(255),
                   channel_id VARCHAR(255),
                   channel_subscription INT,
                   channel_views INT,
                   channel_video_count INT,
                   channel_description TEXT,
                   channel_playlist_id VARCHAR(255)
                )'''

try:
    mycursor.execute(create_query)
except Exception as e:
    print(f"Error creating table: {e}")

for index, row in df.iterrows():
    insert_query = '''Insert into channel_information (channel_name,
                                          channel_id,
                                          channel_subscription,
                                          channel_views,
                                          channel_video_count,
                                          channel_description,
                                          channel_playlist_id)
                      values (%s, %s, %s, %s, %s, %s, %s)'''
    values = (row['channel_name'],
              row['channel_id'],
              row['channel_subscription'],
              row['channel_views'],
              row['channel_video_count'],
              row['channel_description'],
              row['channel_playlist_id'])

    try:
        mycursor.execute(insert_query, values)
    except Exception as e:
        print(f"Error inserting data: {e}")

vi_list = []
db = client["youtube"]
coll1 = db["channel_details"]

for vi_data in coll1.find({}, {"_id": 0, "video_information": 1}):
    video_info = vi_data.get("video_information")
    if video_info is not None:
        vi_list.extend(video_info)

df1 = pd.DataFrame(vi_list)
df1

create_query = '''CREATE TABLE IF NOT EXISTS youtube.video_information (
                   video_id VARCHAR(255),
                   channel_id VARCHAR(255),
                   channel_name VARCHAR(255),
                   video_name VARCHAR(255),
                   video_date VARCHAR(255),
                   video_description TEXT,
                   video_duration TEXT,
                   video_views BIGINT,
                   video_likes BIGINT,
                   video_favourite INT,
                   video_comment_count INT
                )'''

try:
    mycursor.execute(create_query)
except Exception as e:
    print(f"Error creating table: {e}")

for index, row in df1.iterrows():
    insert_query = '''Insert into video_information (video_id,
                                          channel_id,
                                          channel_name,
                                          video_name,
                                          video_date,
                                          video_description,
                                          video_duration,
                                          video_views,
                                          video_likes,
                                          video_favourite,
                                          video_comment_count)
                      values (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)'''
    values = (row['video_id'],
              row['channel_id'],
              row['channel_name'],
              row['video_name'],
              row['video_date'],
              row['video_description'],
              row['video_duration'],
              row['video_views'],
              row['video_likes'],
              row['video_favourite'],
              row['video_comment_count']
             )
    try:
        mycursor.execute(insert_query, values)
    except Exception as e:
        print(f"Error inserting data: {e}")

com_list = []
db = client["youtube"]
coll1 = db["channel_details"]

for com_data in coll1.find({}, {"_id": 0, " comment_information":1}):
    comment_info = com_data.get(" comment_information")
    if comment_info is not None:
        com_list.extend(comment_info)

df2= pd.DataFrame(com_list)
df2

create_query = '''CREATE TABLE IF NOT EXISTS youtube.comment_information (
                   comment_id VARCHAR(255),
                   video_id VARCHAR(255),
                   comment_text TEXT,
                   comment_author TEXT,
                   commented_on VARCHAR(255)
                )'''

try:
    mycursor.execute(create_query)
except Exception as e:
    print(f"Error creating table: {e}")

for index, row in df2.iterrows():
    insert_query = '''Insert into comment_information(comment_id,
                                                      video_id,
                                                      comment_text,
                                                      comment_author,
                                                      commented_on)
                      values (%s, %s, %s, %s, %s)'''
    values = (row['comment_id'],
              row['video_id'],
              row['comment_text'],
              row['comment_author'],
              row['commented_on'])
    try:
        mycursor.execute(insert_query, values)
    except Exception as e:
        print(f"Error inserting data: {e}")

def tables():
    show_table_channel_information()
    show_table_video_information()
    show_table_comment_information()
    return "tables created successfully"

def show_table_channel_information():
    ch_list = []
    db = client["youtube"]
    coll1 = db["channel_details"]
    for ch_data in coll1.find({},{"_id":0}):
        ch_list.append(ch_data["channel_information"])
    df = st.dataframe(ch_list)
    return df



def show_table_video_information():
    vi_list = []
    db = client["youtube"]
    coll1 = db["channel_details"]
    for vi_data in coll1.find({}, {"_id": 0, "video_information": 1}):
        video_info = vi_data.get("video_information")
        if video_info is not None:
            vi_list.extend(video_info)
    df1 = st.dataframe(vi_list)
    return df1


def show_table_comment_information():
    com_list = []
    db = client["youtube"]
    coll1 = db["channel_details"]

    for com_data in coll1.find({}, {"_id": 0, " comment_information":1}):
        comment_info = com_data.get(" comment_information")
        if comment_info is not None:
           com_list.extend(comment_info)
    df2 = st.dataframe(com_list)
    return df2

# streamlit part
with st.sidebar:
    st.title(":red[Youtube Data Harvesting & Warehousing]")
    st.header("skill Takeway")
    st.caption("Python Scripting")
    st.caption("Data Collection")
    st.caption("Mongodb")
    st.caption("API Integration")
    st.caption("Data Management using Mongodb &mySQL")
channel_id = st.text_input("Enter the Channel_id")
if st.button("collect & store data"):
    ch_list = []
    db = client["youtube"]
    coll1 = db["channel_details"]
    for ch_data in coll1.find({}, {"_id": 0}):
        ch_list.append(ch_data["channel_information"]["channel_id"])

    if channel_id in ch_list:
        st.success("Channel details of the given channel ids exists")
    else:
        insert = get_channel_details_1(channel_id)
        st.success(insert)

    vi_list = []
    db = client["youtube"]
    coll1 = db["channel_details"]
    for vi_data in coll1.find({}, {"_id": 0, "video_information": 1}):
        video_info = vi_data.get("video_information")
        if video_info is not None:
            vi_list.extend(video_info)

    com_list = []
    db = client["youtube"]
    coll1 = db["channel_details"]

    for com_data in coll1.find({}, {"_id": 0, " comment_information": 1}):
        comment_info = com_data.get(" comment_information")
        if comment_info is not None:
            com_list.extend(comment_info)


if st.button("Migrate to mySQL"):
        Table = tables()
        st.success(Table)

show_table = st.radio("Select the table for view", ("Channels", "Videos", "Comments"))

if show_table == "Channels":
            show_table_channel_information()

elif show_table == "Videos":
        show_table_video_information()

elif show_table == "Comments":
        show_table_comment_information()


#SQL CONNECTION
import mysql.connector
mycon = mysql.connector.connect(
        host = "localhost",
        user = "root",
        password="12345",
        database = "youtube"
)
mycursor = mycon.cursor()

question = st.selectbox("select your question",("1. What are the names of all the videos and their corresponding channels?",
                                                       "2. Which channels have the most number of videos, and how many videos do they have?",
                                                       "3. What are the top 10 most viewed videos and their respective channels?",
                                                       "4. How many comments were made on each video, and what are theircorresponding video names?",
                                                       "5. Which videos have the highest number of likes, and what are their corresponding channel names?",
                                                       "6. What is the total number of likes and dislikes for each video, and what are their corresponding video names?",
                                                       "7. What is the total number of views for each channel, and what are their corresponding channel names?",
                                                       "8. What are the names of all the channels that have published videos in the year 2022?",
                                                       "9. What is the average duration of all videos in each channel, and what are their corresponding channel names?",
                                                       "10. Which videos have the highest number of comments, and what are their corresponding channel names?"))

if question == "What are the names of all the videos and their corresponding channels?":
    connection_string = ('root@localhost:3306')
    result = sa.create_result(connection_string)
    result.connect()
    query1 = "select * from  youtube.video_name"
    t1=pd.read_sql(query1, result)
    st.dataframe(t1)

if question == "Which channels have the most number of videos, and how many videos do they have?":
    connection_string = ('root@localhost:3306')
    result = sa.create_result(connection_string)
    result.connect()
    query2 = "SELECT channel_name, channel_video_count FROM youtube.channel_information  where channel_video_count=(select max(channel_video_count) from youtube.channel_information);"
    t2=pd.read_sql(query2, result)
    st.dataframe(t2)

if question == "What are the top 10 most viewed videos and their respective channels?":
    connection_string = ('root@localhost:3306')
    result = sa.create_engine(connection_string)
    result.connect()
    query3 = "SELECT video_views  FROM video_information where video_views=(select max(video_views) from youtube.video_information);"
    t3=pd.read_sql(query3, result)
    st.dataframe(t3)

if question == "How many comments were made on each video, and what are their and corresponding video names?":
    connection_string = ('root@localhost:3306')
    result = sa.create_engine(connection_string)
    result.connect()
    query4 = "SELECT video_name,video_comment_count FROM youtube.video_information"
    t4=pd.read_sql(query4, result)
    st.dataframe(t4)

if question == "Which videos have the highest number of likes, and what are their corresponding channel names?":
    connection_string = ('root@localhost:3306')
    result = sa.create_engine(connection_string)
    result.connect()
    query5 = "select channel_name, video_likes from  video_information where video_likes=(select max(video_likes) from youtube.video_information)"
    t5=pd.read_sql(query5, result)
    st.dataframe(t5)

if question == "What is the total number of likes and dislikes for each video, and what are their corresponding video names?":
    connection_string = ('root@localhost:3306')
    result = sa.create_engine(connection_string)
    result.connect()
    query6 = "SELECT video_name,video_likes  FROM youtube.video_information"
    t6=pd.read_sql(query6, result)
    st.dataframe(t6)

if question == "What is the total number of views for each channel, and what are their corresponding channel names?":
    connection_string = ('root@localhost:3306')
    result = sa.create_engine(connection_string)
    result.connect()
    query7 = "SELECT channel_name,channel_views FROM youtube.channel_information order by channel_views desc;"
    t7=pd.read_sql(query7, result)
    st.dataframe(t7)

if question == "What are the names of all the channels that have published videos in the year 2022?":
    connection_string = ('root@localhost:3306')
    result = sa.create_engine(connection_string)
    result.connect()
    query8 = "SELECT channel_name, video_date   FROM youtube.video_information;"
    t8=pd.read_sql(query8, result)
    st.dataframe(t8)

if question == "  What is the average duration of all videos in each channel, and what are their corresponding channel names?":
    connection_string = ('root@localhost:3306')
    result = sa.create_engine(connection_string)
    result.connect()
    query9 = "select video_duration, channel_name from youtube.video_information where video_duration=(select avg(video_duration) from youtube.video_information);"
    t9=pd.read_sql(query9, result)
    st.dataframe(t9)

if question == " Which videos have the highest number of comments, and what are their corresponding channel names?":
    connection_string = ('root@localhost:3306')
    result = sa.create_engine(connection_string)
    result.connect()
    query10 = "select video_comment_count, channel_name from video_information where video_comment_count=(select max(video_comment_count) from video_information);"
    t10=pd.read_sql(query10, result)
    st.dataframe(t10)
